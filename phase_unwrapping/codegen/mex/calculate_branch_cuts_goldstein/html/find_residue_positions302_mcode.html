<pre class="code">
<span class="srcline"><span class="lineno"><a href="1,351" id="srcline351">351</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,352" id="srcline352">352</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,353" id="srcline353">353</a></span><span class="line"><span class="comment">% Determine the positions of all of the residues in the box.</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,354" id="srcline354">354</a></span><span class="line"><span class="keyword">function</span> [<span class="var type1" id="S102T27U766">RESIDUE_BOX_ROWS</span>, <span class="var type1" id="S103T27U767">RESIDUE_BOX_COLS</span>] = find_residue_positions( <span class="keyword">...</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,355" id="srcline355">355</a></span><span class="line">    <span class="var type1" id="S104T1U770">FLAGS_MATRIX</span>, <span class="var type1" id="S105T27U771">ROWS</span>, <span class="var type1" id="S106T27U772">COLS</span>, <span class="var type1" id="S107T2U773">ANCHOR_LOC</span>, <span class="var type1" id="S108T2U774">NUM_RESIDUES</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="1,356" id="srcline356">356</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,357" id="srcline357">357</a></span><span class="line"><span class="comment">% Dimensions of the larger matrix</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,358" id="srcline358">358</a></span><span class="line"><span class="mxinfo " id="T2:U8"><span class="var type1" id="S109T2U777">height</span> = <span class="mxinfo " id="T2:U10">size(<span class="var type1" id="S104T1U780">FLAGS_MATRIX</span>, 1)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,359" id="srcline359">359</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,360" id="srcline360">360</a></span><span class="line"><span class="comment">% Residue flags bit positions</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,361" id="srcline361">361</a></span><span class="line"><span class="mxinfo " id="T2:U12"><span class="var type1" id="S111T2U784">positive_residue_bit_position</span> = <span class="mxinfo " id="T2:U14">1</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,362" id="srcline362">362</a></span><span class="line"><span class="mxinfo " id="T2:U15"><span class="var type1" id="S112T2U788">negative_residue_bit_position</span> = <span class="mxinfo " id="T2:U17">2</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,363" id="srcline363">363</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,364" id="srcline364">364</a></span><span class="line"><span class="comment">% Make vectors out of the row and column positions.</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,365" id="srcline365">365</a></span><span class="line"><span class="mxinfo " id="T34:U18"><span class="var type1" id="S113T34U792">row_vect</span> = <span class="mxinfo " id="T34:U20"><span class="mxinfo " id="T2:U21">min(<span class="mxinfo " id="T27:U22"><span class="var type1" id="S105T27U797">ROWS</span>(:)</span>)</span> : <span class="mxinfo " id="T2:U24">max(<span class="mxinfo " id="T27:U25"><span class="var type1" id="S105T27U802">ROWS</span>(:)</span>)</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,366" id="srcline366">366</a></span><span class="line"><span class="mxinfo " id="T34:U27"><span class="var type1" id="S116T34U806">col_vect</span> = <span class="mxinfo " id="T34:U29"><span class="mxinfo " id="T2:U30">min(<span class="mxinfo " id="T27:U31"><span class="var type1" id="S106T27U811">COLS</span>(:)</span>)</span> : <span class="mxinfo " id="T2:U33">max(<span class="mxinfo " id="T27:U34"><span class="var type1" id="S106T27U816">COLS</span>(:)</span>)</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,367" id="srcline367">367</a></span><span class="line"><span class="mxinfo " id="T2:U36"><span class="var type1" id="S117T2U820">num_box_rows</span> = <span class="mxinfo " id="T2:U38">length(<span class="var type1" id="S113T34U823">row_vect</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,368" id="srcline368">368</a></span><span class="line"><span class="mxinfo " id="T2:U40"><span class="var type1" id="S119T2U826">num_box_cols</span> = <span class="mxinfo " id="T2:U42">length(<span class="var type1" id="S116T34U829">col_vect</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,369" id="srcline369">369</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,370" id="srcline370">370</a></span><span class="line"><span class="comment">% Vector to hold the indices of the residues in the box.</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,371" id="srcline371">371</a></span><span class="line"><span class="mxinfo " id="T27:U44"><span class="var type1" id="S120T27U832">res_inds</span> = <span class="mxinfo " id="T27:U46">zeros(<span class="var type1" id="S108T2U835">NUM_RESIDUES</span>, 1)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,372" id="srcline372">372</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,373" id="srcline373">373</a></span><span class="line"><span class="comment">% Start a counter.</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,374" id="srcline374">374</a></span><span class="line"><span class="mxinfo " id="T2:U48"><span class="var type1" id="S122T2U839">res_cnt</span> = <span class="mxinfo " id="T2:U50">1</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,375" id="srcline375">375</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,376" id="srcline376">376</a></span><span class="line"><span class="comment">% Loop over all the pixels in the box.</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,377" id="srcline377">377</a></span><span class="line"><span class="keyword">for</span> <span class="var type1" id="S123T2U843">box_row</span> = <span class="mxinfo " id="T2:U52">1</span> : <span class="var type1" id="S117T2U846">num_box_rows</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,378" id="srcline378">378</a></span><span class="line">    <span class="keyword">for</span> <span class="var type1" id="S124T2U849">box_col</span> = <span class="mxinfo " id="T2:U55">1</span> : <span class="var type1" id="S119T2U852">num_box_cols</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,379" id="srcline379">379</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,380" id="srcline380">380</a></span><span class="line">        <span class="comment">% Big-array index of box pixel.</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,381" id="srcline381">381</a></span><span class="line">        <span class="mxinfo " id="T2:U57"><span class="var type1" id="S125T2U855">box_ind</span> = <span class="mxinfo " id="T2:U59"><span class="mxinfo " id="T2:U60"><span class="var type1" id="S113T34U858">row_vect</span>(<span class="var type1" id="S123T2U859">box_row</span>)</span> + <span class="mxinfo " id="T2:U63">(<span class="mxinfo " id="T2:U64"><span class="mxinfo " id="T2:U65"><span class="var type1" id="S116T34U864">col_vect</span>(<span class="var type1" id="S124T2U865">box_col</span>)</span> - <span class="mxinfo " id="T2:U68">1</span></span>) * <span class="var type1" id="S109T2U867">height</span></span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,382" id="srcline382">382</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,383" id="srcline383">383</a></span><span class="line">        <span class="comment">% If the pixel corresponds to a residue </span></span></span>
<span class="srcline"><span class="lineno"><a href="1,384" id="srcline384">384</a></span><span class="line">        <span class="comment">% then add its index to the list of residue indices.</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,385" id="srcline385">385</a></span><span class="line">        <span class="keyword">if</span> <span class="mxinfo " id="T3:U70"><span class="mxinfo " id="T2:U71">sum(<span class="mxinfo " id="T49:U72">bitget(<span class="mxinfo " id="T8:U73"><span class="var type1" id="S104T1U876">FLAGS_MATRIX</span>(<span class="var type1" id="S125T2U877">box_ind</span>)</span>, <span class="keyword">...</span></span></span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,386" id="srcline386">386</a></span><span class="line"><span class="mxinfo " id="T3:U70"><span class="mxinfo " id="T2:U71"><span class="mxinfo " id="T49:U72">                [<span class="var type1" id="S111T2U880">positive_residue_bit_position</span>,  <span class="keyword">...</span></span></span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,387" id="srcline387">387</a></span><span class="line"><span class="mxinfo " id="T3:U70"><span class="mxinfo " id="T2:U71"><span class="mxinfo " id="T49:U72">                <span class="var type1" id="S112T2U881">negative_residue_bit_position</span>])</span>)</span> &gt; <span class="mxinfo " id="T2:U78">0</span></span>; </span></span>
<span class="srcline"><span class="lineno"><a href="1,388" id="srcline388">388</a></span><span class="line">            <span class="mxinfo " id="T2:U79"><span class="mxinfo " id="T2:U80"><span class="var type1" id="S120T27U886">res_inds</span>(<span class="var type1" id="S122T2U887">res_cnt</span>)</span> = <span class="var type1" id="S125T2U888">box_ind</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,389" id="srcline389">389</a></span><span class="line">            <span class="mxinfo " id="T2:U84"><span class="var type1" id="S122T2U891">res_cnt</span> = <span class="mxinfo " id="T2:U86"><span class="var type1" id="S122T2U893">res_cnt</span> + <span class="mxinfo " id="T2:U88">1</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,390" id="srcline390">390</a></span><span class="line">        <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,391" id="srcline391">391</a></span><span class="line">        </span></span>
<span class="srcline"><span class="lineno"><a href="1,392" id="srcline392">392</a></span><span class="line">    <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,393" id="srcline393">393</a></span><span class="line"><span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,394" id="srcline394">394</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,395" id="srcline395">395</a></span><span class="line"><span class="comment">% Find the location of the anchor residue. </span></span></span>
<span class="srcline"><span class="lineno"><a href="1,396" id="srcline396">396</a></span><span class="line"><span class="mxinfo " id="T27:U89"><span class="var type1" id="S128T27U897">res_anchor_loc</span> = <span class="mxinfo " id="T27:U91">find(<span class="mxinfo " id="T26:U92"><span class="var type1" id="S120T27U901">res_inds</span> == <span class="var type1" id="S107T2U902">ANCHOR_LOC</span></span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,397" id="srcline397">397</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,398" id="srcline398">398</a></span><span class="line"><span class="comment">% Swap the positions of the anchor pixel and the first pixel</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,399" id="srcline399">399</a></span><span class="line"><span class="comment">% in the list of residue locations.</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,400" id="srcline400">400</a></span><span class="line"><span class="keyword">if</span> <span class="mxinfo " id="T3:U95"><span class="mxinfo " id="T2:U96">max(<span class="mxinfo " id="T27:U97"><span class="var type1" id="S128T27U909">res_anchor_loc</span>(:)</span>)</span> &gt; <span class="mxinfo " id="T2:U99">1</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,401" id="srcline401">401</a></span><span class="line">    <span class="mxinfo " id="T30:U100"><span class="mxinfo " id="T30:U101"><span class="var type1" id="S120T27U915">res_inds</span>(<span class="mxinfo " id="T30:U103">[<span class="mxinfo " id="T2:U104">1</span>, <span class="var type1" id="S128T27U919">res_anchor_loc</span>]</span>)</span> = <span class="mxinfo " id="T30:U106">[<span class="mxinfo " id="T27:U107"><span class="var type1" id="S120T27U923">res_inds</span>(<span class="var type1" id="S128T27U924">res_anchor_loc</span>)</span>, <span class="mxinfo " id="T2:U110"><span class="var type1" id="S120T27U926">res_inds</span>(<span class="mxinfo " id="T2:U112">1</span>)</span>]</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,402" id="srcline402">402</a></span><span class="line"><span class="keyword">end</span>   </span></span>
<span class="srcline"><span class="lineno"><a href="1,403" id="srcline403">403</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,404" id="srcline404">404</a></span><span class="line"><span class="comment">% Convert the index to [row, col]</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,405" id="srcline405">405</a></span><span class="line"><span class="mxinfo " id="T27:U113"><span class="var type1" id="S102T27U930">RESIDUE_BOX_ROWS</span> = <span class="mxinfo " id="T27:U115"><span class="mxinfo " id="T27:U116">rem(<span class="mxinfo " id="T27:U117"><span class="var type1" id="S120T27U935">res_inds</span> - <span class="mxinfo " id="T2:U119">1</span></span>, <span class="var type1" id="S109T2U937">height</span>)</span> + <span class="mxinfo " id="T2:U121">1</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,406" id="srcline406">406</a></span><span class="line"><span class="mxinfo " id="T27:U122"><span class="var type1" id="S103T27U941">RESIDUE_BOX_COLS</span> = <span class="mxinfo " id="T27:U124"><span class="mxinfo " id="T27:U125">(<span class="mxinfo " id="T27:U126"><span class="var type1" id="S120T27U946">res_inds</span> - <span class="var type1" id="S102T27U947">RESIDUE_BOX_ROWS</span></span>) / <span class="var type1" id="S109T2U948">height</span></span> + <span class="mxinfo " id="T2:U130">1</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,407" id="srcline407">407</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,408" id="srcline408">408</a></span><span class="line"><span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,409" id="srcline409">409</a></span><span class="line"></span></span>
</pre>
